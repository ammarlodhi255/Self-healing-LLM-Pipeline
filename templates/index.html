<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLM Self-Healing Pipeline</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
    />
    <link rel="stylesheet" href="/static/css/styles.css" />
    <style>
      /* Basic reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px 0; /* Add padding to keep the container fully visible */
        font-family: "Roboto", sans-serif;
        background-color: #1c1c1c;
        color: #e0e0e0;
      }

      /* Navbar Styling */
      nav {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 1em;
      }

      nav a {
        color: #61dafb;
        text-decoration: none;
        font-size: 1.1em;
      }

      nav a:hover {
        text-decoration: underline;
      }

      /* Hide other sections initially */
      #fileUploadSection {
        display: none;
      }



      /* Header styling */
      header h1 {
        font-size: 1.8em;
        color: #61dafb;
        margin-bottom: 0.5em;
      }

      /* Input Section */
      .input-section label {
        font-size: 1.2em;
        color: #aaa;
      }

      input[type="text"] {
        width: 80%;
        padding: 0.7em;
        margin: 1em 0;
        border: none;
        border-radius: 5px;
        outline: none;
        font-size: 1em;
        background-color: #333;
        color: #ddd;
      }

      /* Submit button */
      button {
        padding: 0.7em 1.5em;
        margin-top: 0.5em;
        font-size: 1em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: #1c1c1c;
        background-color: #61dafb;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #4fb2d9;
      }

      /* Output Section */
      .output-section h2 {
        font-size: 1.5em;
        margin-top: 1.5em;
        color: #61dafb;
      }

      .output-section .iteration {
        background-color: #333;
        padding: 1em;
        margin: 1em 0;
        border-radius: 5px;
        text-align: left;
        font-size: 0.9em;
      }

      .output-section pre {
        background-color: #222;
        padding: 1em;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* Loading Indicator */
      .loader {
        margin: 1em 0;
        border: 4px solid #333;
        border-top: 4px solid #61dafb;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }


      /* Output Section with scrolling */
      .output-section {
        max-height: 50vh; /* Limit height of output section */
        overflow-y: auto; /* Enable vertical scrolling */
        margin-top: 1.5em;
        padding-right: 10px;
      }

      /* Styling for output content */
      .output-section .iteration {
        background-color: #333;
        padding: 1em;
        margin: 1em 0;
        border-radius: 5px;
        text-align: left;
        font-size: 0.9em;
      }

      /* Adjustments for smooth scrolling */
      .output-section::-webkit-scrollbar {
        width: 8px;
      }

      .output-section::-webkit-scrollbar-thumb {
        background-color: #61dafb;
        border-radius: 4px;
      }

      .output-section::-webkit-scrollbar-track {
        background: #2a2a2a;
      }


      /* Input Section */
      .input-section label {
        font-size: 1.2em;
        color: #aaa;
      }

      /* Textarea for prompt input */
      textarea {
        width: 100%;
        height: 100px;
        padding: 0.7em;
        margin: 1em 0;
        border: none;
        border-radius: 5px;
        outline: none;
        font-size: 1em;
        background-color: #333;
        color: #ddd;
        resize: none; /* Prevent resizing */
      }

      /* Button styling */
      .button-container {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 1em;
      }

      button {
        padding: 0.7em 1.5em;
        font-size: 1em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: #1c1c1c;
        background-color: #61dafb;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #4fb2d9;
      }

      /* Specific button styles */
      button:disabled {
        background-color: #888;
        cursor: not-allowed;
      }

      /* Styling for the Current Prompt text */
      #currentPrompt {
        font-size: 1.2em; /* Increase font size */
        padding: 10px 0; /* Add padding for spacing */
        color: #e0e0e0; /* Adjust color to match the theme */
        font-weight: 500; /* Make the text a bit bolder */
      }

      #elapsedTimeCounter,
      #iterationsCounter {
        font-size: 1.1em;
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }

      /* Ensure the main container allows content to expand */
      .container {
        text-align: center;
        width: 80%;
        max-width: 600px;
        padding: 2em;
        background-color: #2a2a2a;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        overflow: visible; /* Allow contents to expand */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        max-height: none; /* Remove height restriction */
        height: auto; /* Adjust to content height */
      }

      .container {

        background-color: #2a2a2a;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        overflow: visible;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      /* Status Container */
      .status-container {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-bottom: 1em;
        padding: 10px 0;
        color: #61dafb;
        border-bottom: 1px solid #444;
      }

      /* Output Section */
      .output-section {
        max-height: 60vh; /* Allow output to grow within a reasonable screen area */
        overflow-y: auto; /* Enable vertical scrolling */
        margin-top: 1.5em;
        padding-right: 10px;
      }

      /* Custom scroll styling */
      .output-section::-webkit-scrollbar {
        width: 8px;
      }

      .output-section::-webkit-scrollbar-thumb {
        background-color: #61dafb;
        border-radius: 4px;
      }

      .output-section::-webkit-scrollbar-track {
        background: #2a2a2a;
      }

      /* Model Selection Styling */
      .model-selection {
        margin-bottom: 1em;
        color: #61dafb;
      }

      .model-selection label {
        font-size: 1.1em;
        margin-right: 10px;
      }

      .model-selection select {
        padding: 0.5em;
        font-size: 1em;
        color: #ddd;
        background-color: #333;
        border: none;
        border-radius: 5px;
        outline: none;
      }

      .model-selection select:focus {
        border: 1px solid #61dafb;
      }

/* Centering Wrapper */
.center-wrapper {
  display: flex;
  justify-content: center;
  align-items: flex-start; /* Align items at the top to prevent truncation */
  gap: 50px; /* Space between code display and main container */
  padding: 20px; /* Add padding to prevent clipping near screen edges */
  overflow-y: auto; /* Enable scrolling if content exceeds window height */
}

/* Code Display Container with White Background and Blue Border */
.code-display-container {
  width: 700px;
  max-height: 100vh; /* Allow it to grow, but with max height */
  overflow-y: auto; /* Enable scrolling if content exceeds */
  background-color: #ffffff;
  border: 8px solid #61dafb;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  padding: 1.5em;
  font-family: "Roboto", sans-serif;
  color: #333;
  display: flex;
  flex-direction: column;
  gap: 1.5em;
  text-align: left;
}

/* Main Heading for Code Display */
.code-display-container h2 {
  font-size: 1.2em;
  color: #333;
  margin: 0 0 0.5em 0;
  text-align: center;
  border-bottom: 1px solid #ddd;
  padding-bottom: 0.5em;
}

/* Individual Code Section */
.code-section {
  padding: 1em;
  background-color: #f9f9f9;
  border-radius: 8px;
  border: 1px solid #ddd;
}

/* Section Headings for Main Code and Test Code */
.code-section h3 {
  font-size: 1em;
  color: #333;
  margin: 0 0 0.5em 0;
}

/* Code Content Style - Larger Display for Code */
.code-section pre {
  background-color: #fff;
  color: #333;
  padding: 1em;
  border-radius: 5px;
  font-size: 0.95em;
  max-height: 400px; /* Increased height */
  overflow-y: auto;
  border: 1px solid #ddd;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Custom Scrollbar for Code Sections */
.code-section pre::-webkit-scrollbar {
  width: 8px;
}

.code-section pre::-webkit-scrollbar-thumb {
  background-color: #61dafb;
  border-radius: 4px;
}

.code-section pre::-webkit-scrollbar-track {
  background: #ddd;
}

/* Main container adjustments to center within flex parent */
.container {
  width: 1000px;
  background-color: #2a2a2a;
  padding: 2em;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
    </style>
  </head>
  <body>
    <div class="center-wrapper">
      <!-- Code Display Container with White Background and Blue Border -->
      <div class="code-display-container">
        <h2>Main Code & Test Code</h2>
        <div class="code-section">
          <h3>Main Code</h3>
          <pre id="generatedCode1Display">No code yet</pre>
        </div>
        <div class="code-section">
          <h3>Test Code</h3>
          <pre id="generatedCode2Display">No code yet</pre>
        </div>
      </div>

    <div class="container">
      <!-- Model Selection Dropdown -->
      <div class="model-selection">
        <label for="modelSelect"><strong>Select Model:</strong></label>
        <select id="modelSelect" onchange="updateModel()">
          <option value="llama3.1">Llama 3.1</option>
          <option value="llama3.2">Llama 3.2</option>
          <option value="codellama">CodeLlama</option>
          <option value="codellama:13b">CodeLlama 13B</option>
        </select>
      </div>

      <div class="status-container">
        <!-- Elapsed Time Counter -->
        <div id="elapsedTimeCounter">
          <strong>Elapsed Time:</strong> <span id="elapsedTime">0</span> seconds
        </div>

        <!-- Iterations Counter -->
        <div id="iterationsCounter">
          <strong>Iterations:</strong> <span id="iterationCount">0</span>
        </div>
      </div>

      <header>
        <h1>LLM Self-Healing Pipeline</h1>
        <nav>
          <a href="#" onclick="showPromptInput()">Enter Single Prompt</a>
          <a href="#" onclick="showFileUpload()">Provide Custom List</a>
        </nav>
      </header>

      <main>
        <!-- Single Prompt Input Section -->
        <section class="input-section" id="singlePromptSection">
          <label for="userPrompt">Enter your prompt:</label>
          <textarea
            id="userPrompt"
            placeholder="Type your prompt here"
          ></textarea>
          <div class="button-container">
            <button onclick="startSinglePromptProcess()">Submit</button>
            <button onclick="resetProcess()">Reset</button>
            <button onclick="stopProcess()">Stop</button>
          </div>
          <div class="loader" id="loadingIndicator" style="display: none"></div>
        </section>

        <!-- File Upload Section for Prompt List -->
        <section
          class="input-section"
          id="fileUploadSection"
          style="display: none"
        >
          <label for="promptFile">Upload a .txt file with prompts:</label>
          <input type="file" id="promptFile" accept=".txt" />
          <div class="button-container">
            <button onclick="uploadAndProcessFile()">Upload & Process</button>
            <button onclick="resetProcess()">Reset</button>
            <button onclick="stopProcess()">Stop</button>
          </div>
          <p id="currentPrompt">Current Prompt: None</p>
          <div
            class="loader"
            id="fileLoadingIndicator"
            style="display: none"
          ></div>
        </section>

        <!-- Output Section for Both Modes -->
        <section class="output-section" id="outputSection">
          <h2>Results</h2>
          <div id="outputContent"></div>
        </section>
      </main>
      <script>
        let socket;
        let isProcessing = false;
        let prompts = []; // Store prompts from uploaded file in list mode
        let currentPromptIndex = 0; // Track current prompt index in list mode
        let currentMode = "single"; // Track whether we are in "single" or "list" mode
        let elapsedTime = 0;
        let elapsedTimeInterval;
        let iterationCount = 0;
        // Track the selected model
        let selectedModel = "llama3.1"; // Default model

        // Function to update the model based on dropdown selection
        function updateModel() {
          const modelSelect = document.getElementById("modelSelect");
          selectedModel = modelSelect.value;
          console.log(`Model updated to: ${selectedModel}`);
        }

        // Start the elapsed time counter
        function startElapsedTimeCounter() {
          console.log("Starting elapsed time counter"); // Debugging line
          elapsedTime = 0;
          document.getElementById("elapsedTime").textContent = elapsedTime;

          // Check if there's already an interval running, and clear it
          if (elapsedTimeInterval) {
            clearInterval(elapsedTimeInterval);
          }

          // Start a new interval
          elapsedTimeInterval = setInterval(() => {
            elapsedTime += 1;
            console.log(`Elapsed time: ${elapsedTime} seconds`); // Debugging line
            document.getElementById("elapsedTime").textContent = elapsedTime;
          }, 1000); // Update every second
        }

        // Stop the elapsed time counter
        function stopElapsedTimeCounter() {
          console.log("Stopping elapsed time counter"); // Debugging line
          clearInterval(elapsedTimeInterval);
          elapsedTimeInterval = null; // Ensure no residual intervals
        }

        // Switch to single prompt mode
        function showPromptInput() {
          resetProcess(); // Reset any ongoing process
          document.getElementById("singlePromptSection").style.display =
            "block";
          document.getElementById("fileUploadSection").style.display = "none";
          currentMode = "single";
        }

        // Switch to prompt list upload mode
        function showFileUpload() {
          resetProcess(); // Reset any ongoing process
          document.getElementById("singlePromptSection").style.display = "none";
          document.getElementById("fileUploadSection").style.display = "block";
          currentMode = "list";
        }

        // Start processing a single prompt (modified to include the timer)
        function startSinglePromptProcess() {
          console.log("Starting single prompt process"); // Debugging line
          const userPrompt = document.getElementById("userPrompt").value;
          if (!userPrompt || isProcessing) return;

          isProcessing = true;
          iterationCount = 0; // Reset iteration count
          document.getElementById("iterationCount").textContent =
            iterationCount;

          startElapsedTimeCounter(); // Start the elapsed time counter immediately
          startWebSocket(userPrompt); // Start the WebSocket communication here
        }

        // Handle file upload and start processing the list of prompts
        function uploadAndProcessFile() {
          const fileInput = document.getElementById("promptFile").files[0];
          if (!fileInput) return alert("Please upload a .txt file");

          const reader = new FileReader();
          reader.onload = function (event) {
            prompts = event.target.result
              .split(/\r?\n/)
              .filter((line) => line.trim() !== "");
            currentPromptIndex = 0;
            if (prompts.length > 0) {
              processNextPrompt();
            } else {
              alert("File is empty");
            }
          };
          reader.readAsText(fileInput);
        }

        // Start WebSocket and send initial prompt
        function startWebSocket(prompt) {
          // Close any existing WebSocket connection
          if (socket) socket.close();

          // Show loading indicator based on mode
          document.getElementById(
            currentMode === "single"
              ? "loadingIndicator"
              : "fileLoadingIndicator"
          ).style.display = "inline-block";

          // Establish a new WebSocket connection
          socket = new WebSocket("ws://localhost:8080/ws");

          socket.onopen = () => {
            console.log("WebSocket connection opened"); // Debugging line
            socket.send(
              JSON.stringify({ prompt: prompt, model: selectedModel })
            );
          };

          socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            displayIteration(data);

            // If compilation succeeds and in list mode, move to the next prompt
            if (data.compiled_successfully && currentMode === "list") {
              currentPromptIndex++;
              socket.close(); // Close WebSocket to reset for next prompt
              processNextPrompt();
            } else if (data.compiled_successfully) {
              isProcessing = false; // End single prompt mode
              stopElapsedTimeCounter(); // Stop the timer when compilation succeeds
              document.getElementById("loadingIndicator").style.display =
                "none";
            }
          };

          socket.onerror = (error) => {
            console.error("WebSocket error:", error);
            stopProcess();
          };

          socket.onclose = () => {
            console.log("WebSocket connection closed"); // Debugging line
            stopElapsedTimeCounter(); // Stop the timer if WebSocket connection closes
            isProcessing = false;
            document.getElementById("loadingIndicator").style.display = "none";
            document.getElementById("fileLoadingIndicator").style.display =
              "none";
          };
        }

        // Process next prompt in the list
        function processNextPrompt() {
          if (currentPromptIndex < prompts.length) {
            const currentPrompt = prompts[currentPromptIndex];
            document.getElementById(
              "currentPrompt"
            ).textContent = `Current Prompt: ${currentPrompt}`;
            isProcessing = true;

            // Show loader each time a new prompt starts processing
            document.getElementById("fileLoadingIndicator").style.display =
              "inline-block";

            startElapsedTimeCounter(); // Start the timer for each new prompt in the list mode
            startWebSocket(currentPrompt); // Send the current prompt
          } else {
            alert("All prompts processed");
            resetProcess();
          }
        }

        // Display each iteration’s output and update counters
        function displayIteration(data) {
          const outputSection = document.getElementById("outputContent");
          const iterationHTML = `
        <div class="iteration">
            <p><strong>Iteration:</strong> ${data.iteration}</p>
            <p><strong>LLM Response:</strong><pre>${
              data.generated_code
            }</pre></p>
            <p><strong>Compiler Output:</strong><pre>${
              data.compiler_output
            }</pre></p>
            <p><strong>Compiled/Tests Passed Successfully:</strong> ${
              data.compiled_successfully ? "Yes" : "No"
            }</p>
        </div>
    `;
          outputSection.innerHTML += iterationHTML;
          outputSection.scrollTop = outputSection.scrollHeight;

          // Update generatedCode1 and generatedCode2 display
          document.getElementById("generatedCode1Display").textContent =
            data.generatedCode1 || "No main code generated";
          document.getElementById("generatedCode2Display").textContent =
            data.generatedCode2 || "No test code generated";

          iterationCount += 1;
          document.getElementById("iterationCount").textContent =
            iterationCount;

          if (data.compiled_successfully) {
            stopElapsedTimeCounter();
          }
        }

        // Stop the current process and keep the current output displayed
        function stopProcess() {
          if (socket) socket.close();
          isProcessing = false;
          stopElapsedTimeCounter(); // Stop timer when the process is stopped manually
        }

        // Reset the process, including counters
        function resetProcess() {
          stopProcess();
          document.getElementById("userPrompt").value = "";
          document.getElementById("outputContent").innerHTML = "";
          document.getElementById("currentPrompt").textContent =
            "Current Prompt: None";
          document.getElementById("loadingIndicator").style.display = "none";
          document.getElementById("fileLoadingIndicator").style.display =
            "none";
          isProcessing = false;
          currentPromptIndex = 0;
          iterationCount = 0;
          elapsedTime = 0;
          document.getElementById("elapsedTime").textContent = elapsedTime;
          document.getElementById("iterationCount").textContent =
            iterationCount;
        }
      </script>
      <!-- <script src="/static/js/script.js"></script> -->
    </div>
  </body>
</html>
